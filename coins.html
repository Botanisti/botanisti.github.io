<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Coin Runner</title>
<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  height: 100%;
  overflow: hidden;
}
canvas {
  display: block;
  background: #111;
}
#ui {
  position: absolute;
  top: 10px;
  left: 10px;
  color: white;
  font-family: sans-serif;
  font-size: 18px;
  z-index: 2;
}
.button {
  background: rgba(255,255,255,0.1);
  color: white;
  padding: 10px;
  border-radius: 5px;
  margin-top: 5px;
  cursor: pointer;
}
#joystick, #firebtn {
  position: absolute;
  bottom: 20px;
  z-index: 3;
  touch-action: none;
}
#joystick {
  left: 20px;
}
#firebtn {
  right: 20px;
  background: rgba(255,0,0,0.4);
  width: 100px;
  height: 100px;
  border-radius: 50%;
}
</style>
</head>
<body>

<canvas id="game"></canvas>
<div id="ui">
  <div id="coins">Coins: 0</div>
  <div class="button" id="startBtn">Uusi juoksu</div>
</div>
<div id="joystick"></div>
<div id="firebtn"></div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let W, H, DPR;
let player = null;
let coins = [];
let bullets = [];
let moveDir = {x:0, y:0};
let aim = {dx:1, dy:0};
let keys = {};
let tempPower = {magnet:0, shield:0};
let meta = {upgrades:{magnet:0}};
let running = false;
let coinCount = 0;
let firePressed = false;
let lastFire = 0;

// iOS zoom estot
document.addEventListener('gesturestart', e => e.preventDefault());
document.addEventListener('dblclick', e => e.preventDefault());

function resize() {
  DPR = window.devicePixelRatio || 1;
  W = window.innerWidth;
  H = window.innerHeight;
  canvas.width = W * DPR;
  canvas.height = H * DPR;
  ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
}
window.addEventListener('resize', resize);
resize();

function startRun() {
  player = {x:W/2, y:H/2, r:15};
  coins = [];
  bullets = [];
  coinCount = 0;
  spawnCoins(10);
  running = true;
}

function spawnCoins(n) {
  for(let i=0;i<n;i++){
    let x, y;
    do {
      x = Math.random() * (W-40) + 20;
      y = Math.random() * (H-40) + 20;
    } while ((x<150 && y>H-150) || (x>W-150 && y>H-150)); // ei ohjainten alle
    coins.push({x,y,r:8});
  }
}

function shoot() {
  let dir;
  if (Math.hypot(moveDir.x, moveDir.y) > 0.01) {
    dir = moveDir;
  } else if (Math.hypot(aim.dx, aim.dy) > 0.01) {
    dir = {x:aim.dx, y:aim.dy};
  } else {
    dir = {x:1, y:0};
  }
  const len = Math.hypot(dir.x, dir.y);
  dir.x /= len;
  dir.y /= len;
  bullets.push({x:player.x, y:player.y, dx:dir.x*6, dy:dir.y*6, r:5});
}

function update(dt) {
  if(!running || !player) return;
  // liike
  player.x += moveDir.x * 3;
  player.y += moveDir.y * 3;
  // rajat
  player.x = Math.max(player.r, Math.min(W-player.r, player.x));
  player.y = Math.max(player.r, Math.min(H-player.r, player.y));
  // kolikot
  for(let i=coins.length-1;i>=0;i--){
    let c = coins[i];
    if (Math.hypot(c.x-player.x, c.y-player.y) < player.r+c.r) {
      coins.splice(i,1);
      coinCount++;
      document.getElementById('coins').textContent = 'Coins: '+coinCount;
    }
  }
  // ammukset
  for(let b of bullets){
    b.x += b.dx;
    b.y += b.dy;
  }
  bullets = bullets.filter(b=>b.x>-10 && b.x<W+10 && b.y>-10 && b.y<H+10);

  // autofire
  if (firePressed && Date.now()-lastFire > 200) {
    shoot();
    lastFire = Date.now();
  }
}

function render() {
  ctx.clearRect(0,0,W,H);
  // kolikot
  ctx.fillStyle = 'gold';
  for(let c of coins){
    ctx.beginPath();
    ctx.arc(c.x, c.y, c.r, 0, Math.PI*2);
    ctx.fill();
  }
  // player
  if (player) {
    ctx.fillStyle = '#7bd7ff';
    ctx.beginPath();
    ctx.arc(player.x, player.y, player.r, 0, Math.PI*2);
    ctx.fill();
    // eye
    let vx = Math.hypot(moveDir.x, moveDir.y) > 0.01 ? moveDir.x : (Math.hypot(aim.dx,aim.dy)>0.01 ? aim.dx : 1);
    let vy = Math.hypot(moveDir.x, moveDir.y) > 0.01 ? moveDir.y : (Math.hypot(aim.dx,aim.dy)>0.01 ? aim.dy : 0);
    const ang = Math.atan2(vy, vx);
    ctx.fillStyle = '#0b2030';
    ctx.beginPath();
    ctx.arc(player.x + Math.cos(ang)*player.r*0.45, player.y + Math.sin(ang)*player.r*0.45, player.r*0.4, 0, Math.PI*2);
    ctx.fill();
  }
  // ammukset
  ctx.fillStyle = 'red';
  for(let b of bullets){
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
    ctx.fill();
  }
}

function loop() {
  update();
  render();
  requestAnimationFrame(loop);
}
loop();

// kontrollerit
document.getElementById('startBtn').addEventListener('click', startRun);

// keyboard
window.addEventListener('keydown', e => {
  keys[e.key] = true;
  if (e.key===' ') { shoot(); }
});
window.addEventListener('keyup', e => { keys[e.key] = false; });
function handleKeys() {
  moveDir.x = (keys['ArrowRight']||keys['d']?1:0) - (keys['ArrowLeft']||keys['a']?1:0);
  moveDir.y = (keys['ArrowDown']||keys['s']?1:0) - (keys['ArrowUp']||keys['w']?1:0);
  requestAnimationFrame(handleKeys);
}
handleKeys();

// mouse aim
canvas.addEventListener('mousemove', e=>{
  const rect = canvas.getBoundingClientRect();
  aim.dx = e.clientX - rect.left - player.x;
  aim.dy = e.clientY - rect.top - player.y;
});

// mobiili joystick
let joy = document.getElementById('joystick');
let joyRect = {x:70,y:H-70};
joy.style.width = '100px';
joy.style.height = '100px';
joy.style.borderRadius = '50%';
joy.style.background = 'rgba(255,255,255,0.1)';

joy.addEventListener('touchstart', e=> e.preventDefault());
joy.addEventListener('touchmove', e=>{
  const t = e.touches[0];
  const rect = joy.getBoundingClientRect();
  const cx = rect.left + rect.width/2;
  const cy = rect.top + rect.height/2;
  let dx = t.clientX - cx;
  let dy = t.clientY - cy;
  const len = Math.hypot(dx,dy);
  if (len>0) {
    dx/=len; dy/=len;
  }
  moveDir.x = dx;
  moveDir.y = dy;
});
joy.addEventListener('touchend', e=>{
  moveDir.x=0; moveDir.y=0;
});

// fire button
let fireBtn = document.getElementById('firebtn');
fireBtn.addEventListener('touchstart', e=>{ e.preventDefault(); firePressed=true; });
fireBtn.addEventListener('touchend', e=>{ firePressed=false; });

</script>
</body>
</html>