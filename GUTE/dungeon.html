<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GUTE - Dungeon</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0f;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, #1a1a2e 0%, #0a0a0f 100%);
            padding: 12px 16px;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .dungeon-title {
            font-size: 16px;
            font-weight: bold;
            color: #e74c3c;
            text-align: center;
        }

        .difficulty {
            font-size: 12px;
            color: #888;
            text-align: center;
            margin-top: 2px;
        }

        /* Boss HP Bar */
        .boss-section {
            padding: 16px;
            background: #12121a;
        }

        .boss-name {
            font-size: 14px;
            color: #888;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .hp-bar-container {
            height: 24px;
            background: #222;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .hp-bar {
            height: 100%;
            background: linear-gradient(90deg, #c0392b 0%, #e74c3c 100%);
            border-radius: 12px;
            transition: width 0.3s ease;
            position: relative;
        }

        .hp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* Party Section */
        .party-section {
            padding: 12px 16px;
            flex: 1;
            overflow-y: auto;
        }

        .section-title {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .player-card {
            background: #1a1a24;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 2px solid transparent;
        }

        .player-card.self {
            border-color: #3498db;
        }

        .player-card.dead {
            opacity: 0.5;
        }

        .player-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .player-icon.anchor {
            background: #2980b9;
        }

        .player-icon.fixer {
            background: #27ae60;
        }

        .player-icon.cannon {
            background: #e74c3c;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .player-role {
            font-size: 11px;
            color: #888;
        }

        .player-hp {
            width: 80px;
        }

        .player-hp-bar {
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
        }

        .player-hp-fill {
            height: 100%;
            background: #27ae60;
            border-radius: 3px;
            transition: width 0.2s, background 0.2s;
        }

        .player-hp-fill.low {
            background: #e74c3c;
        }

        .player-hp-fill.mid {
            background: #f39c12;
        }

        .player-hp-text {
            font-size: 10px;
            color: #888;
            text-align: right;
            margin-top: 2px;
        }

        /* Combat Feed */
        .feed-section {
            padding: 12px 16px;
            background: #0d0d12;
            border-top: 1px solid #222;
            height: 120px;
            overflow: hidden;
        }

        .feed {
            font-size: 12px;
            line-height: 1.6;
        }

        .feed-line {
            color: #aaa;
            animation: fadeIn 0.3s ease;
        }

        .feed-line.damage {
            color: #e74c3c;
        }

        .feed-line.heal {
            color: #27ae60;
        }

        .feed-line.mechanic {
            color: #f39c12;
        }

        .feed-line.win {
            color: #2ecc71;
            font-weight: bold;
        }

        .feed-line.loss {
            color: #e74c3c;
            font-weight: bold;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Action Bar - FIXED BOTTOM */
        .action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #12121a;
            border-top: 2px solid #333;
            padding: 12px 16px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            display: flex;
            gap: 12px;
            align-items: center;
            z-index: 1000;
        }

        .btn {
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-strike {
            flex: 1;
            height: 56px;
            background: linear-gradient(180deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            font-size: 18px;
        }

        .btn-strike:disabled {
            background: #444;
        }

        .btn-skills {
            width: 56px;
            height: 56px;
            background: #2c3e50;
            color: white;
            font-size: 20px;
        }

        .btn-react {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: #333;
            color: #666;
            font-size: 11px;
            flex-direction: column;
            position: relative;
        }

        .btn-react.active {
            background: linear-gradient(180deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            animation: pulse 0.5s infinite alternate;
        }

        .react-timer {
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            background: conic-gradient(#27ae60 var(--progress, 0%), transparent 0);
            mask: radial-gradient(transparent 62%, black 63%);
            -webkit-mask: radial-gradient(transparent 62%, black 63%);
        }

        @keyframes pulse {
            from {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }

            to {
                box-shadow: 0 0 0 12px rgba(231, 76, 60, 0);
            }
        }

        /* Skills Modal */
        .skills-modal {
            display: none;
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a24;
            border-radius: 16px;
            padding: 16px;
            min-width: 200px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .skills-modal.show {
            display: block;
            animation: slideUp 0.2s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .skill-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            background: #2c3e50;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .skill-btn:last-child {
            margin-bottom: 0;
        }

        .skill-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .skill-cd {
            font-size: 11px;
            color: #888;
        }

        /* Screens */
        .screen {
            display: none;
            flex-direction: column;
            flex: 1;
        }

        .screen.active {
            display: flex;
        }

        /* Dungeon List Screen */
        .dungeon-list {
            padding: 16px;
        }

        .dungeon-card {
            background: #1a1a24;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .dungeon-card:hover {
            border-color: #e74c3c;
        }

        .dungeon-card-name {
            font-size: 18px;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 8px;
        }

        .dungeon-card-desc {
            font-size: 13px;
            color: #888;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .dungeon-card-meta {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: #666;
        }

        /* Class Selection */
        .class-selection {
            padding: 16px;
        }

        .class-card {
            background: #1a1a24;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .class-card:hover {
            border-color: #3498db;
        }

        .class-card.selected {
            border-color: #27ae60;
            background: #1a3a1a;
        }

        .class-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .class-desc {
            font-size: 12px;
            color: #888;
        }

        .btn-join {
            margin: 16px;
            padding: 16px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-join:disabled {
            background: #333;
            cursor: not-allowed;
        }

        /* Main content padding for fixed action bar */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 100px;
        }
    </style>
</head>

<body>
    <!-- Dungeon List Screen -->
    <div id="screen-list" class="screen active">
        <div class="header">
            <div class="dungeon-title">üè∞ DUNGEONS</div>
        </div>
        <div class="dungeon-list" id="dungeon-list">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Class Selection Screen -->
    <div id="screen-class" class="screen">
        <div class="header">
            <div class="dungeon-title">CHOOSE YOUR ROLE</div>
        </div>
        <div class="class-selection">
            <div class="class-card" data-class="anchor">
                <div class="class-name">‚öì Anchor (Tank)</div>
                <div class="class-desc">High HP ‚Ä¢ High Defense ‚Ä¢ Taunts boss</div>
            </div>
            <div class="class-card" data-class="fixer">
                <div class="class-name">üíâ Fixer (Healer)</div>
                <div class="class-desc">Average HP ‚Ä¢ Heals allies ‚Ä¢ Keeps party alive</div>
            </div>
            <div class="class-card" data-class="cannon">
                <div class="class-name">üí• Cannon (DPS)</div>
                <div class="class-desc">Average HP ‚Ä¢ High damage ‚Ä¢ Execute ability</div>
            </div>
        </div>
        <button class="btn-join" id="btn-join" disabled>ENTER DUNGEON</button>
    </div>

    <!-- Game Screen -->
    <div id="screen-game" class="screen">
        <div class="header">
            <div class="dungeon-title" id="game-title">The Forgotten Depths</div>
            <div class="difficulty">Normal Difficulty</div>
        </div>

        <div class="main-content">
            <div class="boss-section">
                <div class="boss-name">
                    <span id="boss-name">The Forgotten Guardian</span>
                    <span id="boss-hp-text">8000/8000</span>
                </div>
                <div class="hp-bar-container">
                    <div class="hp-bar" id="boss-hp-bar" style="width: 100%"></div>
                    <div class="hp-text" id="boss-hp-percent">100%</div>
                </div>
            </div>

            <div class="party-section">
                <div class="section-title">Party</div>
                <div id="party-list">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div class="feed-section">
                <div class="section-title">Combat Log</div>
                <div class="feed" id="combat-feed">
                    <div class="feed-line">Waiting for dungeon to start...</div>
                </div>
            </div>
        </div>

        <!-- Fixed Bottom Action Bar -->
        <div class="action-bar">
            <button class="btn btn-strike" id="btn-strike" disabled>
                ‚öîÔ∏è STRIKE
            </button>
            <button class="btn btn-skills" id="btn-skills">
                ‚ö°
            </button>
            <button class="btn btn-react" id="btn-react" disabled>
                <div class="react-timer" id="react-timer"></div>
                <span>‚Äî</span>
            </button>
        </div>

        <!-- Skills Modal -->
        <div class="skills-modal" id="skills-modal">
            <button class="skill-btn" id="skill-1">
                <span id="skill-1-name">Ability 1</span>
                <span class="skill-cd" id="skill-1-cd">Ready</span>
            </button>
            <button class="skill-btn" id="skill-2">
                <span id="skill-2-name">Ability 2</span>
                <span class="skill-cd" id="skill-2-cd">Ready</span>
            </button>
        </div>
    </div>

    <script>
        // ==================== CONFIG ====================
        const API_BASE = 'https://gute.onrender.com/api';
        const POLL_INTERVAL = 500; // ms

        // ==================== STATE ====================
        const state = {
            user: null,
            screen: 'list',
            selectedDungeon: null,
            selectedClass: null,
            instanceId: null,
            playerId: null,
            gameState: null,
            lastFeedLength: 0
        };

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            initTelegram();
            loadDungeonList();
            setupEventListeners();
        });

        function initTelegram() {
            if (window.Telegram?.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();

                // Get user from Telegram
                if (tg.initDataUnsafe?.user) {
                    state.user = tg.initDataUnsafe.user;
                }
            }

            // Fallback for testing outside Telegram
            if (!state.user) {
                state.user = {
                    id: Math.floor(Math.random() * 1000000),
                    username: 'TestPlayer',
                    first_name: 'Test'
                };
            }
        }

        // ==================== API CALLS ====================
        async function api(method, endpoint, data = null) {
            const url = `${API_BASE}${endpoint}`;
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (data) options.body = JSON.stringify(data);

            try {
                const response = await fetch(url, options);
                return await response.json();
            } catch (err) {
                console.error('API Error:', err);
                return { error: err.message };
            }
        }

        // ==================== SCREENS ====================
        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`screen-${screenName}`).classList.add('active');
            state.screen = screenName;
        }

        // ==================== DUNGEON LIST ====================
        async function loadDungeonList() {
            const result = await api('GET', '/dungeons');
            const listEl = document.getElementById('dungeon-list');

            if (result.dungeons) {
                listEl.innerHTML = result.dungeons.map(d => `
                    <div class="dungeon-card" data-id="${d.id}">
                        <div class="dungeon-card-name">${d.name}</div>
                        <div class="dungeon-card-desc">${d.description}</div>
                        <div class="dungeon-card-meta">
                            <span>‚öîÔ∏è ${d.difficulty}</span>
                            <span>üë• ${d.min_players}-${d.max_players} players</span>
                        </div>
                    </div>
                `).join('');

                // Add click handlers
                document.querySelectorAll('.dungeon-card').forEach(card => {
                    card.addEventListener('click', () => {
                        state.selectedDungeon = card.dataset.id;
                        showScreen('class');
                    });
                });
            }
        }

        // ==================== CLASS SELECTION ====================
        function setupEventListeners() {
            // Class cards
            document.querySelectorAll('.class-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.class-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    state.selectedClass = card.dataset.class;
                    document.getElementById('btn-join').disabled = false;
                });
            });

            // Join button
            document.getElementById('btn-join').addEventListener('click', joinDungeon);

            // Game buttons
            document.getElementById('btn-strike').addEventListener('click', doStrike);
            document.getElementById('btn-skills').addEventListener('click', toggleSkills);
            document.getElementById('btn-react').addEventListener('click', doReact);

            // Skill buttons
            document.getElementById('skill-1').addEventListener('click', () => doAbility(1));
            document.getElementById('skill-2').addEventListener('click', () => doAbility(2));
        }

        async function joinDungeon() {
            const btn = document.getElementById('btn-join');
            btn.disabled = true;
            btn.textContent = 'JOINING...';

            // Create instance
            const createResult = await api('POST', '/dungeon/create', {
                dungeon_id: state.selectedDungeon
            });

            if (!createResult.instance_id) {
                btn.disabled = false;
                btn.textContent = 'ENTER DUNGEON';
                return;
            }

            state.instanceId = createResult.instance_id;

            // Join as player
            const joinResult = await api('POST', '/dungeon/join', {
                instance_id: state.instanceId,
                user_id: state.user.id,
                username: state.user.username || state.user.first_name,
                class: state.selectedClass
            });

            if (!joinResult.success) {
                alert('Failed to join: ' + (joinResult.error || 'Unknown error'));
                btn.disabled = false;
                btn.textContent = 'ENTER DUNGEON';
                return;
            }

            state.playerId = joinResult.player_id;

            // Setup skill names based on class
            setupSkillNames(state.selectedClass);

            // Start game
            showScreen('game');
            startPolling();
        }

        function setupSkillNames(className) {
            const names = {
                anchor: ['TAUNT (6s)', 'GUARD (50% dmg‚Üì)'],
                fixer: ['HEAL ally', 'WARD (shield)'],
                cannon: ['EXECUTE (boss<20%)', 'SECOND WIND']
            };
            document.getElementById('skill-1-name').textContent = names[className][0];
            document.getElementById('skill-2-name').textContent = names[className][1];
        }

        // ==================== GAME LOOP ====================
        let pollInterval;

        function startPolling() {
            pollGameState();
            pollInterval = setInterval(pollGameState, POLL_INTERVAL);
        }

        async function pollGameState() {
            const state_data = await api('GET', `/dungeon/state?instance_id=${state.instanceId}&user_id=${state.user.id}`);

            if (state_data.error) {
                console.error('Poll error:', state_data.error);
                return;
            }

            state.gameState = state_data;
            updateUI(state_data);
        }

        // ==================== UI UPDATES ====================
        function updateUI(gameState) {
            // Boss HP
            const boss = gameState.boss;
            const bossHpPct = (boss.hp / boss.hp_max * 100).toFixed(1);
            document.getElementById('boss-hp-bar').style.width = bossHpPct + '%';
            document.getElementById('boss-hp-text').textContent = `${boss.hp}/${boss.hp_max}`;
            document.getElementById('boss-hp-percent').textContent = bossHpPct + '%';

            // Party
            updatePartyList(gameState.players, gameState.self);

            // Feed
            updateFeed(gameState.feed);

            // Self state
            if (gameState.self) {
                updateSelfState(gameState.self);
            }
        }

        function updatePartyList(players, selfState) {
            const container = document.getElementById('party-list');
            container.innerHTML = players.map(p => {
                const isSelf = selfState && p.id === selfState.player_id;
                const hpPct = (p.hp / p.hp_max * 100).toFixed(0);
                const hpClass = hpPct < 30 ? 'low' : hpPct < 60 ? 'mid' : '';
                const icons = { anchor: '‚öì', fixer: 'üíâ', cannon: 'üí•' };

                return `
                    <div class="player-card ${isSelf ? 'self' : ''} ${p.is_dead ? 'dead' : ''}">
                        <div class="player-icon ${p.class}">${icons[p.class]}</div>
                        <div class="player-info">
                            <div class="player-name">${p.username} ${isSelf ? '(You)' : ''}</div>
                            <div class="player-role">${p.class.toUpperCase()}</div>
                        </div>
                        <div class="player-hp">
                            <div class="player-hp-bar">
                                <div class="player-hp-fill ${hpClass}" style="width: ${hpPct}%"></div>
                            </div>
                            <div class="player-hp-text">${p.is_dead ? 'DEAD' : p.hp + '/' + p.hp_max}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateFeed(feed) {
            if (!feed || feed.length === state.lastFeedLength) return;

            const container = document.getElementById('combat-feed');
            const typeClasses = {
                strike: 'damage',
                execute: 'damage',
                heal: 'heal',
                mechanic_start: 'mechanic',
                mechanic_hit: 'damage',
                win: 'win',
                loss: 'loss'
            };

            container.innerHTML = feed.slice(-6).map(line => {
                const cls = typeClasses[line.type] || '';
                let text = line.message;
                if (!text) {
                    if (line.type === 'strike') text = `${line.actor_name} STRIKES for ${line.amount}`;
                    else if (line.type === 'boss_attack') text = `Boss hits ${line.target_name} for ${line.amount}`;
                    else text = `${line.type}: ${line.actor_name}`;
                }
                return `<div class="feed-line ${cls}">${text}</div>`;
            }).join('');

            state.lastFeedLength = feed.length;
        }

        function updateSelfState(self) {
            // Strike button
            const strikeBtn = document.getElementById('btn-strike');
            if (self.is_dead) {
                strikeBtn.disabled = true;
                strikeBtn.innerHTML = '‚ò†Ô∏è DEAD';
            } else if (self.strike_cd > 0) {
                strikeBtn.disabled = true;
                strikeBtn.innerHTML = `‚è±Ô∏è ${self.strike_cd.toFixed(1)}s`;
            } else {
                strikeBtn.disabled = false;
                strikeBtn.innerHTML = '‚öîÔ∏è STRIKE';
            }

            // Skills cooldown
            const skill1Btn = document.getElementById('skill-1');
            const skill2Btn = document.getElementById('skill-2');

            skill1Btn.disabled = self.ability1_cd > 0 || self.is_dead;
            document.getElementById('skill-1-cd').textContent = self.ability1_cd > 0
                ? `${self.ability1_cd.toFixed(1)}s`
                : 'Ready';

            skill2Btn.disabled = self.ability2_cd > 0 || self.is_dead;
            document.getElementById('skill-2-cd').textContent = self.ability2_cd > 0
                ? `${self.ability2_cd.toFixed(1)}s`
                : 'Ready';

            // React button
            const reactBtn = document.getElementById('btn-react');
            const timerEl = document.getElementById('react-timer');

            if (self.react) {
                reactBtn.disabled = false;
                reactBtn.classList.add('active');
                reactBtn.querySelector('span').textContent = 'DODGE!';

                // Update timer ring
                const progress = (self.react.time_left / self.react.total_time) * 100;
                const color = progress > 50 ? '#27ae60' : progress > 25 ? '#f39c12' : '#e74c3c';
                timerEl.style.setProperty('--progress', progress + '%');
                timerEl.style.background = `conic-gradient(${color} ${progress}%, transparent 0)`;
            } else {
                reactBtn.disabled = true;
                reactBtn.classList.remove('active');
                reactBtn.querySelector('span').textContent = '‚Äî';
                timerEl.style.setProperty('--progress', '0%');
            }
        }

        // ==================== ACTIONS ====================
        async function doStrike() {
            const result = await api('POST', '/dungeon/strike', {
                instance_id: state.instanceId,
                player_id: state.playerId
            });

            if (!result.success) {
                console.log('Strike failed:', result.error);
            }
        }

        async function doAbility(num) {
            document.getElementById('skills-modal').classList.remove('show');

            const result = await api('POST', '/dungeon/ability', {
                instance_id: state.instanceId,
                player_id: state.playerId,
                ability_num: num
            });

            if (!result.success) {
                console.log('Ability failed:', result.error);
            }
        }

        async function doReact() {
            const result = await api('POST', '/dungeon/react', {
                instance_id: state.instanceId,
                player_id: state.playerId
            });

            if (result.success) {
                console.log('Dodged!', result.perfect ? 'PERFECT!' : '');
            }
        }

        function toggleSkills() {
            const modal = document.getElementById('skills-modal');
            modal.classList.toggle('show');
        }

        // Close skills when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('skills-modal');
            const btn = document.getElementById('btn-skills');
            if (!modal.contains(e.target) && e.target !== btn) {
                modal.classList.remove('show');
            }
        });
    </script>
</body>

</html>